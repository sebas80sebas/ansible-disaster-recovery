---
# Playbook to simulate a catastrophic disaster
# WARNING: This is DESTRUCTIVE and will cause DATA LOSS

- name: Simulate Disaster - Total Data Loss
  hosts: all
  become: true
  
  vars_prompt:
    - name: confirmation
      prompt: "Type 'destroy' to continue with disaster simulation or Ctrl+C to abort"
      private: no

  tasks:
    - name: Check confirmation
      fail:
        msg: "Disaster simulation aborted by user"
      when: confirmation != "destroy"

    - name: Display disaster simulation warning
      debug:
        msg:
          - "=========================================="
          - "⚠️  DISASTER SIMULATION ⚠️"
          - "=========================================="
          - "This playbook will simulate a catastrophic failure by:"
          - "  - Stopping all application containers"
          - "  - Removing all Docker volumes (DATA LOSS)"
          - "  - Removing all Docker containers"
          - ""
          - "⚠️  THIS WILL DESTROY ALL CURRENT DATA ⚠️"
          - ""
          - "Use this only for:"
          - "  - Testing disaster recovery procedures"
          - "  - Training exercises"
          - "  - Non-production environments"
          - ""
          - "Environment: {{ env_name }}"
          - "=========================================="

    - name: Record disaster simulation start time
      set_fact:
        disaster_start_time: "{{ ansible_date_time.iso8601 }}"

    - name: Get current application state (before disaster)
      uri:
        url: "http://localhost:{{ app_port }}/health"
        status_code: 200
      register: pre_disaster_check
      ignore_errors: yes

    - name: Save pre-disaster state
      copy:
        content: "{{ pre_disaster_check | to_nice_json }}"
        dest: "/tmp/pre_disaster_state.json"
      when: pre_disaster_check.status is defined

    - name: Stop and remove application containers
      shell:
        cmd: "docker compose down -v"
        chdir: "/opt/{{ app_name }}"
      ignore_errors: yes

    - name: Wait for containers to stop
      pause:
        seconds: 3

    - name: Remove Docker volumes (SIMULATING DATA LOSS)
      docker_volume:
        name: "{{ item }}"
        state: absent
      loop:
        - "{{ app_name }}_db_data"
        - "{{ app_name }}_app_data"
      ignore_errors: yes

    - name: Remove application containers
      docker_container:
        name: "{{ item }}"
        state: absent
      loop:
        - "{{ app_name }}_app"
        - "{{ app_name }}_db"
      ignore_errors: yes

    - name: Verify disaster - containers should be gone
      shell: "docker ps -a --filter \"name={{ app_name }}\" --format '{% raw %}{{.Names}}{% endraw %}'"
      register: disaster_verify
      changed_when: false

    - name: Display verification result
      debug:
        msg: "Containers remaining: {{ disaster_verify.stdout if disaster_verify.stdout else 'NONE (Success)' }}"

    - name: Disaster simulation complete
      debug:
        msg:
          - "=========================================="
          - "Disaster simulation completed at {{ ansible_date_time.iso8601 }}"
          - "The application is now DOWN and DATA is LOST."
          - "Run restore.yml to recover the system."
          - "=========================================="