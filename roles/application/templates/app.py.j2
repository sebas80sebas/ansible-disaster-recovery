#!/usr/bin/env python3
"""
Simple Todo Application with PostgreSQL
Demonstrates containerized app with persistent data
"""

from flask import Flask, request, jsonify, render_template_string
import psycopg2
import os
from datetime import datetime
import logging

app = Flask(__name__)
logging.basicConfig(level=logging.INFO)

# Database configuration from environment
DB_CONFIG = {
    'host': os.getenv('DB_HOST', 'db'),
    'database': os.getenv('DB_NAME', 'tododb'),
    'user': os.getenv('DB_USER', 'todouser'),
    'password': os.getenv('DB_PASSWORD', 'password'),
    'port': os.getenv('DB_PORT', '5432')
}

def get_db_connection():
    """Create database connection"""
    return psycopg2.connect(**DB_CONFIG)

@app.route('/health')
def health():
    """Health check endpoint"""
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute('SELECT 1')
        cur.close()
        conn.close()
        return jsonify({
            'status': 'healthy',
            'database': 'connected',
            'timestamp': datetime.now().isoformat()
        }), 200
    except Exception as e:
        return jsonify({
            'status': 'unhealthy',
            'database': 'disconnected',
            'error': str(e),
            'timestamp': datetime.now().isoformat()
        }), 503

@app.route('/')
def index():
    """Main page"""
    html = """
    <!DOCTYPE html>
    <html>
    <head>
        <title>Todo App - Disaster Recovery Demo</title>
        <style>
            body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
            h1 { color: #333; }
            .todo { padding: 10px; margin: 10px 0; background: #f0f0f0; border-radius: 5px; }
            .completed { text-decoration: line-through; opacity: 0.6; }
            input, button { padding: 10px; margin: 5px; }
            .stats { background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 20px 0; }
        </style>
    </head>
    <body>
        <h1>üìù Todo Application</h1>
        <div class="stats">
            <h3>Disaster Recovery Demo</h3>
            <p>This application demonstrates automated backup and recovery.</p>
            <p>Server Time: <span id="time"></span></p>
        </div>
        
        <h2>Add Todo</h2>
        <form id="todoForm">
            <input type="text" id="todoText" placeholder="Enter todo..." required>
            <button type="submit">Add</button>
        </form>
        
        <h2>Todo List</h2>
        <div id="todoList"></div>
        
        <script>
            function updateTime() {
                fetch('/health')
                    .then(r => r.json())
                    .then(data => {
                        document.getElementById('time').textContent = data.timestamp;
                    });
            }
            
            function loadTodos() {
                fetch('/api/todos')
                    .then(r => r.json())
                    .then(data => {
                        const list = document.getElementById('todoList');
                        list.innerHTML = data.todos.map(todo => 
                            `<div class="todo ${todo.completed ? 'completed' : ''}">
                                ${todo.title} 
                                <button onclick="toggleTodo(${todo.id})">${todo.completed ? 'Undo' : 'Complete'}</button>
                                <button onclick="deleteTodo(${todo.id})">Delete</button>
                            </div>`
                        ).join('');
                    });
            }
            
            document.getElementById('todoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const text = document.getElementById('todoText').value;
                fetch('/api/todos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title: text})
                }).then(() => {
                    document.getElementById('todoText').value = '';
                    loadTodos();
                });
            });
            
            function toggleTodo(id) {
                fetch(`/api/todos/${id}/toggle`, {method: 'PUT'})
                    .then(() => loadTodos());
            }
            
            function deleteTodo(id) {
                fetch(`/api/todos/${id}`, {method: 'DELETE'})
                    .then(() => loadTodos());
            }
            
            updateTime();
            loadTodos();
            setInterval(updateTime, 5000);
        </script>
    </body>
    </html>
    """
    return render_template_string(html)

@app.route('/api/todos', methods=['GET'])
def get_todos():
    """Get all todos"""
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute('SELECT id, title, completed, created_at FROM todos ORDER BY created_at DESC')
        todos = []
        for row in cur.fetchall():
            todos.append({
                'id': row[0],
                'title': row[1],
                'completed': row[2],
                'created_at': row[3].isoformat() if row[3] else None
            })
        cur.close()
        conn.close()
        return jsonify({'todos': todos})
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/todos', methods=['POST'])
def create_todo():
    """Create new todo"""
    try:
        data = request.json
        title = data.get('title')
        if not title:
            return jsonify({'error': 'Title required'}), 400
        
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute('INSERT INTO todos (title) VALUES (%s) RETURNING id', (title,))
        todo_id = cur.fetchone()[0]
        conn.commit()
        cur.close()
        conn.close()
        
        return jsonify({'id': todo_id, 'message': 'Todo created'}), 201
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/todos/<int:todo_id>/toggle', methods=['PUT'])
def toggle_todo(todo_id):
    """Toggle todo completion"""
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute('UPDATE todos SET completed = NOT completed WHERE id = %s', (todo_id,))
        conn.commit()
        cur.close()
        conn.close()
        return jsonify({'message': 'Todo toggled'})
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/todos/<int:todo_id>', methods=['DELETE'])
def delete_todo(todo_id):
    """Delete todo"""
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute('DELETE FROM todos WHERE id = %s', (todo_id,))
        conn.commit()
        cur.close()
        conn.close()
        return jsonify({'message': 'Todo deleted'})
    except Exception as e:
        return jsonify({'error': str(e)}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=False)
