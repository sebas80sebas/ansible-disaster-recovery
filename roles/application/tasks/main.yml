---
# Application role - Deploy containerized application

- name: Create application directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "/opt/{{ app_name }}"
    - "/opt/{{ app_name }}/app"

- name: Copy application files
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode }}"
  loop:
    - { src: 'docker-compose.yml.j2', dest: '/opt/{{ app_name }}/docker-compose.yml', mode: '0644' }
    - { src: 'app.py.j2', dest: '/opt/{{ app_name }}/app/app.py', mode: '0644' }
    - { src: 'requirements.txt.j2', dest: '/opt/{{ app_name }}/app/requirements.txt', mode: '0644' }
    - { src: 'Dockerfile.j2', dest: '/opt/{{ app_name }}/app/Dockerfile', mode: '0644' }
    - { src: 'init.sql.j2', dest: '/opt/{{ app_name }}/init.sql', mode: '0644' }

- name: Create .env file with secrets
  template:
    src: env.j2
    dest: "/opt/{{ app_name }}/.env"
    mode: '0600'

- name: Build and start application containers
  shell:
    cmd: "docker compose up -d --build"
    chdir: "/opt/{{ app_name }}"
  register: compose_output

- name: Wait for application to be ready
  wait_for:
    host: localhost
    port: "{{ app_port }}"
    delay: 5
    timeout: 60

- name: Display application status
  debug:
    msg:
      - "Application deployed successfully!"
      - "URL: http://localhost:{{ app_port }}"