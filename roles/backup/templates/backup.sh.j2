#!/bin/bash
# Automated Backup Script
# Managed by Ansible - Do not edit manually

set -euo pipefail

# Configuration
APP_NAME="{{ app_name }}"
BACKUP_BASE="{{ backup_base_path }}"
TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
BACKUP_DIR="${BACKUP_BASE}/${TIMESTAMP}"
DB_NAME="{{ db_name }}"
DB_USER="{{ db_user }}"
DB_CONTAINER="${APP_NAME}_db"
APP_CONTAINER="${APP_NAME}_app"
COMPRESSION="{{ backup_compression | lower }}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging function
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] ERROR:${NC} $1" >&2
}

warning() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] WARNING:${NC} $1"
}

# Start backup process
log "=========================================="
log "Starting backup process"
log "Backup directory: ${BACKUP_DIR}"
log "=========================================="

# Create backup directory structure
mkdir -p "${BACKUP_DIR}/volumes"
mkdir -p "${BACKUP_DIR}/database"
mkdir -p "${BACKUP_DIR}/configs"

# Record backup start time
BACKUP_START=$(date +%s)

# 1. Backup Docker volumes
log "Backing up Docker volumes..."
VOLUME_START=$(date +%s)

# Backup database volume
if docker volume inspect "${APP_NAME}_db_data" &>/dev/null; then
    log "Backing up database volume..."
    docker run --rm \
        -v "${APP_NAME}_db_data:/source:ro" \
        -v "${BACKUP_DIR}/volumes:/backup" \
        alpine \
        tar czf /backup/db_data.tar.gz -C /source .
    log "Database volume backed up"
else
    warning "Database volume not found"
fi

# Backup application volume
if docker volume inspect "${APP_NAME}_app_data" &>/dev/null; then
    log "Backing up application volume..."
    docker run --rm \
        -v "${APP_NAME}_app_data:/source:ro" \
        -v "${BACKUP_DIR}/volumes:/backup" \
        alpine \
        tar czf /backup/app_data.tar.gz -C /source .
    log "Application volume backed up"
else
    warning "Application volume not found"
fi

VOLUME_END=$(date +%s)
VOLUME_TIME=$((VOLUME_END - VOLUME_START))
log "Volume backup completed in ${VOLUME_TIME} seconds"

# 2. Backup PostgreSQL database
log "Backing up PostgreSQL database..."
DB_START=$(date +%s)

# Check if container exists and is running
if docker ps --format '{% raw %}{{.Names}}{% endraw %}' | grep -q "^${DB_CONTAINER}$"; then
    log "Executing pg_dump..."
    docker exec "${DB_CONTAINER}" pg_dump -U "${DB_USER}" -d "${DB_NAME}" > "${BACKUP_DIR}/database/${DB_NAME}.sql"
    
    if [ "${COMPRESSION}" = "true" ]; then
        gzip "${BACKUP_DIR}/database/${DB_NAME}.sql"
    fi
    
    log "Database backup completed"
else
    error "Database container ${DB_CONTAINER} not found or not running"
    # Don't exit here if it's the first run, but mark as error
fi

DB_END=$(date +%s)
DB_TIME=$((DB_END - DB_START))

# 3. Backup configuration files
log "Backing up configuration files..."
CONFIG_START=$(date +%s)

cp "/opt/${APP_NAME}"/*.yml "${BACKUP_DIR}/configs/" 2>/dev/null || true
cp "/opt/${APP_NAME}/.env" "${BACKUP_DIR}/configs/" 2>/dev/null || true
cp "/opt/${APP_NAME}/init.sql" "${BACKUP_DIR}/configs/" 2>/dev/null || true

CONFIG_END=$(date +%s)
CONFIG_TIME=$((CONFIG_END - CONFIG_START))

# 4. Create metadata
log "Creating metadata..."
cat > "${BACKUP_DIR}/backup_metadata.json" <<EOF
{
    "backup_timestamp": "${TIMESTAMP}",
    "app_name": "${APP_NAME}",
    "environment": "{{ env_name }}"
}
EOF

# Latest symlink
rm -f "${BACKUP_BASE}/latest"
ln -s "${BACKUP_DIR}" "${BACKUP_BASE}/latest"

log "Backup process finished"
exit 0