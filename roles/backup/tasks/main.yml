---
# Backup role - Automated backup system

- name: Create backup script directory
  file:
    path: /opt/backup_scripts
    state: directory
    mode: '0755'

- name: Install backup script
  template:
    src: backup.sh.j2
    dest: /opt/backup_scripts/backup.sh
    mode: '0755'

- name: Install backup verification script
  template:
    src: verify_backup.sh.j2
    dest: /opt/backup_scripts/verify_backup.sh
    mode: '0755'

- name: Create backup retention cleanup script
  template:
    src: cleanup_old_backups.sh.j2
    dest: /opt/backup_scripts/cleanup_old_backups.sh
    mode: '0755'

- name: Ensure backup directories exist
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ backup_base_path }}"
    - "{{ backup_base_path }}/archives"
    - "{{ backup_base_path }}/logs"

- name: Configure automated backup cron job
  cron:
    name: "Automated application backup"
    minute: "{{ backup_schedule.split()[0] }}"
    hour: "{{ backup_schedule.split()[1] }}"
    day: "{{ backup_schedule.split()[2] }}"
    month: "{{ backup_schedule.split()[3] }}"
    weekday: "{{ backup_schedule.split()[4] }}"
    job: "/opt/backup_scripts/backup.sh >> {{ backup_base_path }}/logs/backup.log 2>&1"
    state: "{{ 'present' if backup_enabled else 'absent' }}"

- name: Configure backup cleanup cron job
  cron:
    name: "Cleanup old backups"
    minute: "0"
    hour: "2"
    job: "/opt/backup_scripts/cleanup_old_backups.sh >> {{ backup_base_path }}/logs/cleanup.log 2>&1"
    state: "{{ 'present' if backup_enabled else 'absent' }}"

- name: Create backup status check script
  template:
    src: check_backup_status.sh.j2
    dest: /opt/backup_scripts/check_backup_status.sh
    mode: '0755'

- name: Verify backup system is ready
  debug:
    msg: "Backup system installed and scripts configured in /opt/backup_scripts/"